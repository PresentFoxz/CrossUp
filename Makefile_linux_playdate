# Linux Makefile for CrossUp (Playdate)
# Builds simulator (.so) and device (.elf) using the Playdate SDK's common.mk

# -----------------------------------------------------------------------
# SDK path
SDK = $(PLAYDATE_SDK_PATH)
ifeq ($(SDK),)
SDK = /home/dylan/Documents/PlaydateSDK
endif
SDK := $(patsubst ~%,$(HOME)%,$(SDK))

ifeq ($(wildcard $(SDK)/C_API/pd_api.h),)
$(error Playdate SDK not found at "$(SDK)". Set PLAYDATE_SDK_PATH.)
endif

# -----------------------------------------------------------------------
# Product name — different for sim vs device so both can coexist
ifeq ($(MAKECMDGOALS),device)
PRODUCT = CrossUp-dev.pdx
else
PRODUCT = CrossUp-sim.pdx
endif

HEAP_SIZE  = 8388208
STACK_SIZE = 61800

# -----------------------------------------------------------------------
# Source files — playdate + shared engine folders, exclude raylib
SRCDIR     = C
SRC_FOLDERS = playdate Foxgine allFiles textures

SRC = $(foreach dir,$(SRC_FOLDERS),$(shell find $(SRCDIR)/$(dir) -name "*.c"))

# -----------------------------------------------------------------------
# Include all subdirectories except raylib-specific
UINCDIR = $(shell find $(SRCDIR) -type d -not -path "$(SRCDIR)/raylib*")

# Provide newlib syscall stubs for bare-metal ARM link
ULIBS = -specs=nosys.specs

# -----------------------------------------------------------------------
# Assets
OBJ_SRC   = $(SRCDIR)/Objects
AUDIO_SRC = $(SRCDIR)/Audio

# -----------------------------------------------------------------------
# Populate Source/ at parse time (pdc reads from Source/)
$(shell mkdir -p Source)
$(shell cp $(SRCDIR)/pdxinfo Source/ 2>/dev/null || true)
$(shell if [ -d "$(OBJ_SRC)" ]; then cp -r "$(OBJ_SRC)" Source/ 2>/dev/null || true; fi)
$(shell if [ -d "$(AUDIO_SRC)/music" ]; then mkdir -p Source/music && cp -r "$(AUDIO_SRC)/music/." Source/music/ 2>/dev/null || true; fi)
$(shell if [ -d "$(AUDIO_SRC)/sfx" ]; then mkdir -p Source/sfx && cp -r "$(AUDIO_SRC)/sfx/." Source/sfx/ 2>/dev/null || true; fi)
# Stub main.lua — defines playdate.update() so firmware Lua VM is satisfied.
# Actual game loop runs via C eventHandler(kEventUpdate).
$(shell echo '-- CrossUp C extension' > Source/main.lua)
$(shell echo 'function playdate.update() end' >> Source/main.lua)

# -----------------------------------------------------------------------
include $(SDK)/C_API/buildsupport/common.mk

# -----------------------------------------------------------------------
.PHONY: clean-assets

clean-assets:
	@rm -rf Source/pdxinfo Source/Objects Source/music Source/sfx Source/main.lua
	@rm -rf Source/pdex.so Source/pdex.elf Source/pdex.dylib Source/pdex.dll Source/pdex.bin Source/main.pdz

clean: clean-assets
