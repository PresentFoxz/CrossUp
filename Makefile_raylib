# Raylib project Makefile - recursive source compilation

# Compiler
CC = gcc

# Detect Raylib via pkg-config
RAYLIB_PKG := $(shell pkg-config --exists raylib 2>/dev/null && echo "yes" || echo "no")

ifeq ($(RAYLIB_PKG),yes)
    # Use pkg-config if available
    RAYLIB_CFLAGS := $(shell pkg-config --cflags raylib)
    RAYLIB_LDFLAGS := $(shell pkg-config --libs raylib)
else
    # Fallback: try common installation paths
    RAYLIB_PATHS := /usr/local/include /usr/include /opt/raylib/include ~/raylib/src ./raylib/src
    RAYLIB_LIB_PATHS := /usr/local/lib /usr/lib /opt/raylib/lib ~/raylib/src ./raylib/src
    
    # Find raylib header and library (prefer same directory)
    RAYLIB_FOUND_PATH := $(shell for path in $(RAYLIB_PATHS); do \
        if [ -f "$$path/raylib.h" ]; then \
            echo "$$path"; \
            break; \
        fi \
    done)
    
    # Set include path
    RAYLIB_INCLUDE := $(if $(RAYLIB_FOUND_PATH),-I$(RAYLIB_FOUND_PATH),)
    
    # Try to find library in the same directory as header first, then in standard lib paths
    RAYLIB_LIBDIR := $(shell \
        if [ -n "$(RAYLIB_FOUND_PATH)" ] && [ -f "$(RAYLIB_FOUND_PATH)/libraylib.a" -o -f "$(RAYLIB_FOUND_PATH)/libraylib.so" ]; then \
            echo "-L$(RAYLIB_FOUND_PATH)"; \
        else \
            for path in $(RAYLIB_LIB_PATHS); do \
                if [ -f "$$path/libraylib.a" ] || [ -f "$$path/libraylib.so" ]; then \
                    echo "-L$$path"; \
                    break; \
                fi \
            done; \
        fi)
    
    RAYLIB_CFLAGS := $(RAYLIB_INCLUDE)
    RAYLIB_LDFLAGS := $(RAYLIB_LIBDIR) -lraylib -lm -lpthread -ldl -lrt -lX11
endif

MINGW_BIN = /mingw64/bin

# DLLs needed for raylib programs
DLLS = libraylib.dll glfw3.dll libwinpthread-1.dll libgcc_s_seh-1.dll

# Directories
SRCDIR = C
BINDIR = bin

# Folders to include
SRC_FOLDERS = Foxgine raylib textures allFiles

# Find all .c files in selected folders
SRC = $(foreach dir,$(SRC_FOLDERS),$(shell find $(SRCDIR)/$(dir) -name "*.c"))

# Include all subdirectories except playdate
INCLUDES = $(shell find $(SRCDIR) -type d -not -path "$(SRCDIR)/playdate*" | sed 's/^/-I/')

# Objects folder to copy
OBJ_SRC = $(SRCDIR)/Objects

# Compiler flags
CFLAGS = -Wall -Wextra -std=c2x -O2 $(RAYLIB_CFLAGS) $(INCLUDES)
DEBUG_CFLAGS = -Wall -Wextra -std=c2x -g -DDEBUG $(RAYLIB_CFLAGS) $(INCLUDES)

OUT = $(BINDIR)/CrossUp.exe

check-raylib:
	@echo "Checking for raylib..."
ifeq ($(RAYLIB_PKG),yes)
	@echo "✓ Found raylib via pkg-config"
	@echo "  CFLAGS: $(RAYLIB_CFLAGS)"
	@echo "  LDFLAGS: $(RAYLIB_LDFLAGS)"
else ifneq ($(RAYLIB_CFLAGS),)
	@echo "✓ Found raylib at: $(RAYLIB_CFLAGS)"
	@echo "  LDFLAGS: $(RAYLIB_LDFLAGS)"
else
	@echo "✗ raylib not found!"
	@false
endif

mesh:
	@echo "Deleting old Objects folder in $(BINDIR)..."
	@if [ -d "$(BINDIR)/Objects" ]; then rm -rf "$(BINDIR)/Objects"; fi
	@echo "Copying new Objects folder into $(BINDIR)..."
	@mkdir -p $(BINDIR)
	@if [ -d "$(OBJ_SRC)" ]; then cp -r "$(OBJ_SRC)" "$(BINDIR)"; fi

doctor: check-raylib
raylib-check: check-raylib
all: check-raylib build

# Create output directory
directories:
	@mkdir -p $(BINDIR)

# Build release version
build: directories mesh
	$(CC) $(CFLAGS) $(SRC) -o $(OUT) $(RAYLIB_LDFLAGS)
	@echo "Copying required DLLs to $(BINDIR)..."
	@mkdir -p $(BINDIR)
	@for dll in /mingw64/bin/libraylib.dll /mingw64/bin/glfw3.dll /mingw64/bin/libwinpthread-1.dll /mingw64/bin/libgcc_s_seh-1.dll; do \
		cp "$$dll" $(BINDIR)/; \
	done

debug: directories
	$(CC) $(DEBUG_CFLAGS) $(SRC) -o $(OUT) $(RAYLIB_LDFLAGS)
	@echo "Copying required DLLs to $(BINDIR)..."
	@mkdir -p $(BINDIR)
	@for dll in /mingw64/bin/libraylib.dll /mingw64/bin/glfw3.dll /mingw64/bin/libwinpthread-1.dll /mingw64/bin/libgcc_s_seh-1.dll; do \
		cp "$$dll" $(BINDIR)/; \
	done

# Clean build artifacts
clean:
	@echo "Cleaning..."
	rm -rf $(BINDIR)/*

.PHONY: build debug run run-debug clean directories mesh doctor raylib-check all check-raylib